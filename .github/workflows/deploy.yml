name: Build and Deploy

on:
  push:
    branches:
      - main
      - feature/deploy

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: Run tests
        run: ./gradlew test

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/onsamiro-welfare-service/onsae_be:latest

  deploy:
    needs: build-and-push
    runs-on: [self-hosted, onsae_be]

    steps:
      - name: Log in to GitHub Container Registry
        run: |
          echo "ğŸ” GitHub Container Registry ë¡œê·¸ì¸ ì¤‘..."
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "âœ… ë¡œê·¸ì¸ ì™„ë£Œ"

      - name: Check current containers
        run: |
          echo "ğŸ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸..."
          docker ps -a --filter "name=onsae"

      - name: Deploy with docker-compose
        run: |
          echo "ğŸš€ ë°°í¬ ì‹œì‘ (ìµœì‹  ì´ë¯¸ì§€ Pull ë° ì»¨í…Œì´ë„ˆ ì¬ìƒì„±)..."
          echo "ì‘ì—… ë””ë ‰í† ë¦¬: /home/onsae/onsaemiro/deploy/_work/be"
          echo "Compose íŒŒì¼: docker-compose.be.yaml"
          cd /home/onsae/onsaemiro/deploy/_work/be
          docker-compose -f docker-compose.be.yaml up -d --pull always --force-recreate
          echo "âœ… ë°°í¬ ì™„ë£Œ"

      - name: Verify deployment
        run: |
          echo "âœ… ë°°í¬ í›„ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
          docker ps --filter "name=onsae"
          echo ""
          echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 20ì¤„):"
          docker-compose -f /home/onsae/onsaemiro/deploy/_work/be/docker-compose.be.yaml logs --tail=20

      - name: Clean up old images
        run: |
          echo "ğŸ§¹ 72ì‹œê°„ ì´ìƒ ëœ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
          docker image prune -af --filter "until=72h"
          echo "âœ… ì •ë¦¬ ì™„ë£Œ"
